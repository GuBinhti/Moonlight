<!DOCTYPE html>
<html>
<head>
  <title>Moonlight Simulator Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button, input { margin: 5px; padding: 10px; }
    img { margin-top: 20px; max-width: 90%; height: auto; }
    #status, #simStatus { margin-top: 15px; padding: 10px; background-color: #f0f0f0; }
    .settings { margin-top: 20px; }
    .badge { padding: 8px 12px; color: white; border-radius: 5px; }
    .running { background-color: green; }
    .stopped { background-color: red; }
  </style>
</head>
<body>
  <h1>Moonlight Simulator</h1>

  <div id="simStatus">
    Simulation Status: <span id="simStateBadge" class="badge stopped">Stopped</span>
  </div>

  <button onclick="startSimulation()">Start Simulation</button>
  <button onclick="endSimulation()">End Simulation</button>
  <button onclick="plotPhaseAngle()">Plot Phase Angles</button>
  <button onclick="plotRiseSet()">Plot Rise/Set Times</button>
  <button onclick="plotPhases()">Plot Phases</button>

  <div>
    <input type="number" id="dayInput" placeholder="Enter Day Index">
    <button onclick="plotAltitude()">Plot Altitude</button>
  </div>

  <button onclick="getStatus()">Show Full Status</button>

  <div class="settings">
    <h3>Change Settings</h3>
    <input type="number" id="cycleInput" placeholder="New Cycle Length">
    <input type="number" id="speedInput" placeholder="Speed Factor">
    <input type="number" id="dayLengthInput" placeholder="Day Length (sec)">
    <input type="text" id="hexInput" placeholder="Hex Color (e.g., FF0000)">
    <input type="text" id="feedStartInput" placeholder="Feed Start (e.g., 19:00)">
    <input type="text" id="feedEndInput" placeholder="Feed End (e.g., 04:00)">
    <button onclick="changeSettings()">Apply Changes</button>
  </div>

  <div id="status"></div>
  <img id="plotImage" src="" alt="Plot will appear here">

  <script>
    async function startSimulation() {
      const res = await axios.get('/start-simulation');
      alert(res.data.message);
      updateSimStatus();
    }

    async function endSimulation() {
      const res = await axios.get('/end-simulation');
      alert(res.data.message);
      updateSimStatus();
    }

    async function plotPhaseAngle() {
      const res = await axios.get('/plot-phase-angle');
      document.getElementById('plotImage').src = res.data.image;
    }

    async function plotRiseSet() {
      const res = await axios.get('/plot-rise-set');
      document.getElementById('plotImage').src = res.data.image;
    }

    async function plotPhases() {
      const res = await axios.get('/plot-phases');
      document.getElementById('plotImage').src = res.data.image;
    }

    async function plotAltitude() {
      const day = document.getElementById('dayInput').value;
      const res = await axios.post('/plot-altitude', { day: parseInt(day) });
      if (res.data.image) {
        document.getElementById('plotImage').src = res.data.image;
      } else {
        alert('Invalid day index');
      }
    }

    async function getStatus() {
      const res = await axios.get('/status');
      let text = '';
      for (const key in res.data) {
        text += `<b>${key}</b>: ${res.data[key]}<br>`;
      }
      document.getElementById('status').innerHTML = text;
    }

    async function changeSettings() {
      const cycle = parseInt(document.getElementById('cycleInput').value);
      const speed = parseFloat(document.getElementById('speedInput').value);
      const dayLength = parseFloat(document.getElementById('dayLengthInput').value);
      const hex = document.getElementById('hexInput').value;
      const feedStart = document.getElementById('feedStartInput').value;
      const feedEnd = document.getElementById('feedEndInput').value;

      const res = await axios.post('/change-settings', {
        cycle_length: cycle || null,
        speed_factor: speed || null,
        day_length: dayLength || null,
        hex_color: hex || null,
        feed_start_time: feedStart || null,
        feed_end_time: feedEnd || null
      });

      alert(res.data.message);
      updateSimStatus();
    }

    async function updateSimStatus() {
      const res = await axios.get('/status');
      const badge = document.getElementById('simStateBadge');
      if (res.data['Simulation Started']) {
        badge.innerText = 'Running';
        badge.classList.remove('stopped');
        badge.classList.add('running');
      } else {
        badge.innerText = 'Stopped';
        badge.classList.remove('running');
        badge.classList.add('stopped');
      }
    }

    setInterval(updateSimStatus, 3000);
    updateSimStatus();
  </script>
</body>
</html>
